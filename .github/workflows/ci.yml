name: CI - Spring Boot + Compose

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]

permissions:
  contents: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  COMPOSE_FILE: compose.yaml
  APP_IMAGE_TAG: aplicacao:latest
  HEALTH_URLS: |
    http://localhost:8088/actuator/health
    http://localhost:8081/actuator/health

jobs:
  build-test-compose:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Temurin JDK 17 (cache Maven)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven

      - name: Rodar testes Maven
        run: mvn -B -DskipTests=false verify

      - name: Publicar relatórios de teste
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: |
            **/target/surefire-reports/**
            **/target/failsafe-reports/**
          if-no-files-found: ignore

      - name: Setup QEMU (opcional, mas útil p/ buildx)
        uses: docker/setup-qemu-action@v3

      - name: Setup Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build da imagem Docker local (aplicacao:latest)
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          load: true
          tags: ${{ env.APP_IMAGE_TAG }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Subir compose (MySQL + API)
        run: |
          docker compose -f "${COMPOSE_FILE}" up -d
          docker compose -f "${COMPOSE_FILE}" ps

      - name: Aguardar MySQL saudável
        run: |
          # confere health do serviço mysql por até 90s
          for i in {1..45}; do
            STATUS=$(docker inspect --format='{{json .State.Health.Status}}' barberapp-mysql || echo "null")
            echo "mysql health: $STATUS"
            if [ "$STATUS" = "\"healthy\"" ]; then
              exit 0
            fi
            sleep 2
          done
          echo "MySQL não ficou saudável a tempo"
          docker compose -f "${COMPOSE_FILE}" logs mysql || true
          exit 1

      - name: Smoke test da API
        run: |
          # tenta as URLs configuradas (8088 e fallback 8081)
          set +e
          ok=0
          for url in $HEALTH_URLS; do
            echo "aguardando API em: $url"
            for i in {1..60}; do
              if curl -fsS "$url" | grep -qi "UP"; then
                echo "API saudável em $url"
                ok=1
                break 2
              fi
              sleep 2
            done
          done
          if [ "$ok" -ne 1 ]; then
            echo "API não respondeu saudável"
            exit 1
          fi
        shell: bash

      - name: Logs containers (se falhar)
        if: failure()
        run: |
          docker compose -f "${COMPOSE_FILE}" logs --no-color > compose-logs.txt || true

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: compose-logs
          path: compose-logs.txt
          if-no-files-found: ignore

      - name: Derrubar compose e limpar
        if: always()
        run: |
          docker compose -f "${COMPOSE_FILE}" down -v
          docker system prune -af || true
